<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>HyphaMind Dashboard</title>
  <link rel="icon" href="assets/img/favicon.ico">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="brand" href="index.html">
        <img src="assets/logo.svg" alt="HyphaMind logo">
        <span>HyphaMind</span>
      </a>
      <p class="tagline">Demo dashboard fed by SPORE-vetted cart geometry. Use it to explore the metabolic loop.</p>
    </div>
    <nav class="site-nav">
      <a href="index.html">Home</a>
      <a href="quickstart.html">Quickstart</a>
      <a href="architecture.html">Architecture</a>
      <a href="primitives.html">Primitives</a>
      <a href="chorus.html">Chorus</a>
      <a href="telemetry-consent.html">Telemetry &amp; Consent</a>
      <a href="ci-covenant.html">CI Covenant</a>
      <a href="api.html">API</a>
      <a href="glossary.html">Glossary</a>
      <a href="dashboard.html" class="active">Dashboard</a>
    </nav>
  </header>
  <main class="container">
    <section class="section">
      <h1>Consent-first dashboard</h1>
      <p class="lead">This page loads <span class="code-inline">data/cart_geometry_map.json</span>, visualises the metabolic loop, and highlights entropy measured by EYE.</p>
      <div class="card" data-accent="teal" id="dashboard-status">Loading demo geometry…</div>
    </section>

    <section class="section dashboard-grid">
      <section class="dashboard-list" id="nodes-list">
        <h3>Nodes</h3>
        <ul></ul>
      </section>
      <section class="dashboard-list" id="edges-list">
        <h3>Edges</h3>
        <ul></ul>
      </section>
    </section>

    <section class="section">
      <div class="card" data-accent="gold">
        <h3>Metrics</h3>
        <div class="flex flex-column flex-auto" id="metrics"></div>
      </div>
    </section>

    <section class="section">
      <div class="card" data-accent="amber">
        <h3>Evidence paths</h3>
        <pre id="evidence-paths">(loading…)</pre>
      </div>
    </section>
  </main>
  <footer class="footer">
    <div class="container">
      <strong>HyphaMind</strong>
      <small>Consent-first orchestration spine for multi-agent systems.</small>
      <small>&copy; 2024 HyphaMind Collective.</small>
    </div>
  </footer>

  <script type="application/json" id="fallback-geometry">
  {
    "run_id": "site-demo-1",
    "topology_manifest": {
      "nodes": [
        {"id": "ROOT"}, {"id": "VALVE"}, {"id": "CLASP"}, {"id": "TRACE"},
        {"id": "MIRE"}, {"id": "SCAR"}, {"id": "COMPOST"}, {"id": "SPORE"}
      ],
      "edges": [
        {"src": "ROOT", "dst": "VALVE"}, {"src": "VALVE", "dst": "CLASP"}, {"src": "CLASP", "dst": "TRACE"},
        {"src": "TRACE", "dst": "MIRE"}, {"src": "MIRE", "dst": "SCAR"}, {"src": "SCAR", "dst": "COMPOST"},
        {"src": "COMPOST", "dst": "SPORE"}, {"src": "SPORE", "dst": "ROOT"}
      ]
    },
    "metrics": {"semantic_topology_entropy": 0.74},
    "query": {
      "evidence_paths": [["channel:theory", "ROOT", "VALVE", "CLASP", "TRACE", "EYE", "CART", "BARD"]]
    }
  }
  </script>
  <script>
    function renderDashboard(data, note) {
      const status = document.getElementById('dashboard-status');
      status.textContent = note || `Run ${data.run_id} loaded.`;

      const nodesList = document.querySelector('#nodes-list ul');
      const edgesList = document.querySelector('#edges-list ul');
      const metricsEl = document.getElementById('metrics');
      const evidenceEl = document.getElementById('evidence-paths');

      nodesList.innerHTML = '';
      data.topology_manifest.nodes.forEach(node => {
        const li = document.createElement('li');
        li.textContent = node.id;
        nodesList.appendChild(li);
      });

      edgesList.innerHTML = '';
      data.topology_manifest.edges.forEach(edge => {
        const li = document.createElement('li');
        li.textContent = `${edge.src} → ${edge.dst}`;
        edgesList.appendChild(li);
      });

      metricsEl.innerHTML = '';
      Object.entries(data.metrics || {}).forEach(([key, value]) => {
        const stat = document.createElement('div');
        stat.className = 'stat';
        const label = document.createElement('span');
        label.className = 'label';
        label.textContent = key.replace(/_/g, ' ');
        const strong = document.createElement('strong');
        strong.textContent = value;
        stat.appendChild(label);
        stat.appendChild(strong);
        metricsEl.appendChild(stat);
      });

      const evidence = (data.query && data.query.evidence_paths) || [];
      if (evidence.length) {
        evidenceEl.textContent = evidence.map(path => path.join(' → ')).join('\n');
      } else {
        evidenceEl.textContent = 'No evidence paths available.';
      }
    }

    async function loadDashboard() {
      const fallback = document.getElementById('fallback-geometry').textContent;
      let parsedFallback;
      try {
        parsedFallback = JSON.parse(fallback);
      } catch (error) {
        console.error('Failed to parse fallback geometry', error);
      }

      try {
        const response = await fetch('data/cart_geometry_map.json', { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        renderDashboard(data);
      } catch (error) {
        console.warn('Falling back to embedded geometry', error);
        if (parsedFallback) {
          renderDashboard(parsedFallback, 'Loaded fallback geometry snapshot.');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>
